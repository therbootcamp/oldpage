<!DOCTYPE html>
<html>
  <head>
    <title>Data Wranging with dplyr</title>
    <meta charset="utf-8">
    <meta name="author" content="The R Bootcamp Twitter: @therbootcamp" />
    <link href="libs/remark-css/example.css" rel="stylesheet" />
    <link rel="stylesheet" href="../_css/my-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Data Wranging with dplyr
### The R Bootcamp<br/>Twitter: <a href='https://twitter.com/therbootcamp'><span class="citation">@therbootcamp</span></a>
### September 2017

---





# dplyr
.pull-left4[

dplyr is a package for managing dataframes.

Anytime you want to slice, dice, aggregate, or manipulate a dataframe, there is almost certainly a way to do it in dplyr.

&lt;img src="../_image/dplyr_hex.png" width="50%" style="display: block; margin: auto;" /&gt;



]


.pull-right5[

### Questions you can answer with dplyr

&gt; *Can you calculate the mean survival times for each treatment separated by gender and time?*

&gt; *I need to know the mean birth rate only for countries in Africa from 1980 to 1980.*

&gt; *What percent of female patients had adverse events to drug X during weeks 5 through 10?*

]
---

# dplyr CheatSheet!
https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf

&lt;img src="../_image/data_wrangling_ss.png" width="600" style="display: block; margin: auto;" /&gt;




---

.pull-left4[
# dplyr

dplyr is a combination of 3 things:

1. **`objects`** like dataframes
2. **`verbs`** that **do** things to objects.
3. **`pipes`** `%&gt;%` that string together objects and verbs

&lt;br&gt;


&lt;img src="../_image/pipe.jpg" width="70%" style="display: block; margin: auto;" /&gt;


]


.pull-right5[

&lt;br&gt;
&lt;br&gt;
&lt;br&gt;

&lt;img src="../_image/sequential.png" width="70%" style="display: block; margin: auto;" /&gt;


dplyr is meant to be sequential and work like language

&gt; Take data X, then do Y, then do Z...

Here's the basic structure of `dplyr` in action


```r
data %&gt;%           # Start with data, and THEN
     VERB1 %&gt;%     # Do VERB1, (and THEN)
     VERB2 %&gt;% ... # Do VERB2, (and THEN)
```

]



---

.pull-left4[
# dplyr


### Question:

&gt; From the ChickWeight dataframe, calculate the mean weight and time for each diet

]


.pull-right4[

### Answer:

```r
library(dplyr)

x &lt;- ChickWeight %&gt;%  # Start with ChickWeight
  group_by(Diet) %&gt;%  # Group by Diet
  summarise(          # Get ready to summarise....
    weight.mean = mean(weight), # Mean weight
    time.mean = mean(Time),     # Mean time
    N = n()                     # Number of cases
  )
  

x
```

```
## # A tibble: 4 x 4
##     Diet weight.mean time.mean     N
##   &lt;fctr&gt;       &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;
## 1      1       102.6     10.48   220
## 2      2       122.6     10.92   120
## 3      3       142.9     10.92   120
## 4      4       135.3     10.75   118
```

]




---


# Common dplyr verbs

| verb| action| example |
|:---|:----|:----------------|
|     `filter()`|    Select rows based on some criteria| `filter(age &gt; 40 &amp; sex == "m")`|
|     `arrange()`|    Sort rows| `arrange(date, group)`|
|     `select()`|    Select columns (and ignore all others)| `select(age, sex)`|
|     `rename()`|    Rename columns| `rename(DATE_MONTHS_X24, date`)|
|     `mutate()`|    Add new columns| `mutate(height.m = height.cm / 100)`|
|     `case_when()`|    Recode values of a column| `sex.n = case_when(sex == 0 ~ "m", sex == 1 ~ "f")`|
|     `group_by(), summarise()`|   Group data and then calculate summary statistics|`group_by(treatment) %&gt;% summarise(...)` |






---

#### Ex: Chick 1

*Add a column called `weight_d_time` that is weight divided by time*


```r
library(dplyr)

x &lt;- ChickWeight %&gt;%          # Start with the ChickWeight data
      mutate(                 # Create new columns...
            weight_d_time = weight / Time
            )

head(x)   # Print the result
```

```
##   weight Time Chick Diet Diet_name weight_d_time
## 1     42    0     1    1     fruit           Inf
## 2     51    2     1    1     fruit         25.50
## 3     59    4     1    1     fruit         14.75
## 4     64    6     1    1     fruit         10.67
## 5     76    8     1    1     fruit          9.50
## 6     93   10     1    1     fruit          9.30
```



---

#### Ex: Chick 2

*Add a column called `weight_d_time` that is weight divided by time AND `time_d` that is time in days*


```r
x &lt;- ChickWeight %&gt;%          # Start with the ChickWeight data
      mutate(                 # Create new columns...
            weight_d_time = weight / Time,  # weight_d_time is weight divided by Time
            time_d = Time * 7               # time_d is Time times 7
            )

head(x)   # Print the result
```

```
##   weight Time Chick Diet Diet_name weight_d_time time_d
## 1     42    0     1    1     fruit           Inf      0
## 2     51    2     1    1     fruit         25.50     14
## 3     59    4     1    1     fruit         14.75     28
## 4     64    6     1    1     fruit         10.67     42
## 5     76    8     1    1     fruit          9.50     56
## 6     93   10     1    1     fruit          9.30     70
```

---


### Recoding values with case_when()

.pull-left4[
Recoding values is a common data wrangling task. You can easily do this with `case_when()`:


```r
data %&gt;%
  mutate(
  var_new = case_when(
    var_old == OLD_A ~ NEW_A,
    var_old == OLD_B ~ NEW_B
  )
```



For example, in a dataset, the column `sex` might be coded with 1s and 0s.

You might want to create a new column `sex_new` where 1 = "female" and 0 = "male":

| sex| sex_new|
|------:|----:|
|    1|   "female"|
|    0|   "male"|

]

.pull-right5[



To change the value of 1 to `"female"`, and 0 to `"male"`, you can use `case_when()`:



```r
# Add a column sex_new to data 

data &lt;- data %&gt;% 
  mutate(
        sex_new = case_when(
          sex == 1 ~ "female",
          sex == 0 ~ "male"
        )
  )
```


You can think about the code above as follows:

- Create a new column `sex_new` where
    - If `sex == 1`, then set the value to `"female"`
    - If `sex == 0`, then set the value to `"male"`

]


---

.pull-left4[
#### Ex: Chick 3

*Create a new variable Diet_name which shows Diet in text format. Here is a table of the values*

| Diet| Diet_name|
|------:|----:|
|    1|   "fruit"|
|    2|   "vegetables"|
|    3|   "meat"|
|    4|   "grains"|

]

.pull-right5[


```r
ChickWeight &lt;- ChickWeight %&gt;%           # Start with the ChickWeight data
                 mutate(
                   Diet_name = case_when(
                     Diet == 1 ~ "fruit",
                     Diet == 2 ~ "vegetables",
                     Diet == 3 ~ "meat",
                     Diet == 4 ~ "grains"
                   )
   
 )

head(ChickWeight)
```

```
##   weight Time Chick Diet Diet_name
## 1     42    0     1    1     fruit
## 2     51    2     1    1     fruit
## 3     59    4     1    1     fruit
## 4     64    6     1    1     fruit
## 5     76    8     1    1     fruit
## 6     93   10     1    1     fruit
```


]






---

#### Ex: Chick 3

*For each Diet, calculate the mean weight*


```r
ChickWeight %&gt;%           # Start with the ChickWeight data
  group_by(Diet) %&gt;%      # Group the data by Diet
  summarise(              # Now summarise....
    weight.mean = mean(weight) # Mean weight
  )
```

```
## # A tibble: 4 x 2
##     Diet weight.mean
##   &lt;fctr&gt;       &lt;dbl&gt;
## 1      1       102.6
## 2      2       122.6
## 3      3       142.9
## 4      4       135.3
```





---

#### Ex: Chick 4

*For each time period less than 10, calculate the mean weight*


```r
ChickWeight %&gt;%                # Start with the ChickWeight data
  filter(Time &lt; 10) %&gt;%        # Only Time periods less than 10
  group_by(Time) %&gt;%           # Group the data by Diet
  summarise(                   # Now summarise....
    weight.mean = mean(weight) # Mean weight
  )
```

```
## # A tibble: 5 x 2
##    Time weight.mean
##   &lt;dbl&gt;       &lt;dbl&gt;
## 1     0       41.06
## 2     2       49.22
## 3     4       59.96
## 4     6       74.31
## 5     8       91.24
```





---
#### Ex: Chick 5:

*For each Diet, calculate the mean weight, maximum time, and the number of chicks on each diet*:


```r
ChickWeight %&gt;%           # Start with the ChickWeight data
  group_by(Diet) %&gt;%      # Group the data by Diet
  summarise(              # Now summarise....
    weight.mean = mean(weight), # Mean weight
    time.max = max(Time),       # Max time
    N = n()                     # Number of observations
  )
```

```
## # A tibble: 4 x 4
##     Diet weight.mean time.max     N
##   &lt;fctr&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;
## 1      1       102.6       21   220
## 2      2       122.6       21   120
## 3      3       142.9       21   120
## 4      4       135.3       21   118
```




---


# Other dplyr verbs


| verb| action| example |
|:---|:----|:----------------|
|     `sample_n()`|    Select a random sample of n rows| `sample_n(10)`|
|     `sample_frac()`|    Select a random fraction of rows| `sample_frac(.20)`|
|     `first(), last()`|    Give the first (or last) observation| `first(), last()`|



---

#### Ex: Chick 6:

*Give me a random sample of 10 rows from the ChickWeight dataframe, but only show me the values for Chick and weight*


```r
# Give me a random sample of 10 rows, but only show me columns Chick and weight

ChickWeight %&gt;% 
  select(Chick, weight) %&gt;%
  sample_n(10)
```

```
##     Chick weight
## 465    41    103
## 19      2    122
## 218    20    107
## 444    39    146
## 20      2    138
## 243    22    164
## 285    26     93
## 550    48    170
## 138    12    119
## 476    42     84
```


---
.pull-left4[

#dplyr

dplyr operations (almost) always return a dataframe which you can assign to a new object:


&gt; *Create a dataframe with the average weight for each time period and nothing else!!*

]

.pull-right5[


```r
# Create a new object called time_agg

time_agg &lt;- ChickWeight %&gt;%
  group_by(Time) %&gt;%
  summarise(
    weight.mean = mean(weight)
  )

head(time_agg)
```

```
## # A tibble: 6 x 2
##    Time weight.mean
##   &lt;dbl&gt;       &lt;dbl&gt;
## 1     0       41.06
## 2     2       49.22
## 3     4       59.96
## 4     6       74.31
## 5     8       91.24
## 6    10      107.84
```


]


---

.pull-left4[

#dplyr summary

dplyr is great for elegantly performing sequential operations on data.

The 'pipe' operator `%&gt;%` helps you string multiple *objects* (like dataframes) and *verbs* (summarise, order, aggregate...) together.


&lt;img src="../_image/dplyr_hex.png" width="50%" style="display: block; margin: auto;" /&gt;


]




.pull-right5[

&lt;br&gt;
&lt;br&gt;

Basic structure of dplyr commands:


```r
data %&gt;%    # Start with data, AND THEN...
  VERB1 %&gt;% # Do VERB1, AND THEN...
  VERB2 %&gt;% # Do VERB2, AND THEN...
  VERB3 %&gt;% # Do VERB3, AND THEN...
  group_by(x, y) %&gt;%  # Group by variables x, y
    summarise(
      VAR_A_New = fun(X),
      VAR_B_New = fun(Y)
    )
  )
```

### Questions?

]

---


.pull-left4[
#tidyr

`tidyr` is a package for 'tidying' data.

'tidying' data means getting it into a different format (usually moving data between rows and columns)


&lt;img src="../_image/tidyr_hex.png" width="70%" style="display: block; margin: auto;" /&gt;
]


.pull-right5[

&lt;br&gt;
&lt;br&gt;

### Questions you can answer with tidyr

&gt; Right now there are different rows for each patient, I need every patient's data to be in a single row.

&gt; Can you restructure the data so data in different columns are shown in a single column?

]



---
#tidyr

There are two important functions in `tidyr`, `gather()` and `spread()`:

.pull-left4[

`gather()`: Move data from *columns* into many *rows*


&lt;img src="../_image/gather_ss.png" width="80%" style="display: block; margin: auto;" /&gt;
]


.pull-right5[

`spread()`: Move data from several *rows* into columns

&lt;img src="../_image/spread_ss.png" width="80%" style="display: block; margin: auto;" /&gt;

]
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {window.dispatchEvent(new Event('resize'));});
(function() {var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler"); if (!r) return; s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }"; d.head.appendChild(s);})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
