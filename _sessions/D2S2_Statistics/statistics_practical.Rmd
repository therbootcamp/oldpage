---
title: "Practical: Statistics"
author: "BaselRBootcamp 2017"
output: html_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(comment=NA, fig.width=6, fig.height=6, echo = FALSE, eval = FALSE)
```


```{r, echo = FALSE, fig.align = 'center', eval = TRUE, out.width = "70%", fig.cap= "Source: https://cdn.lynda.com/course/495322/495322-636154038826424503-16x9.jpg"}
knitr::include_graphics("https://cdn.lynda.com/course/495322/495322-636154038826424503-16x9.jpg")
```


### Slides

- [Here are the introduction slides for this practical on statistics!](https://therbootcamp.github.io/_sessions/D2S2_Statistics/Statistics.html)

### Overview

In this practical you'll conduct hypothesis tests. By the end of this practical you will know how to:

1. Calculate basic descriptive statistics.
2. Conduct 1 and 2 sample hypothesis tests with `t.test()`, `cor.test()` and `chisq.test()`
3. Calculate regression analyses with `glm()`
4. Explore statistical objects with `names()`, `summary()`, `print()`, `predict()`
5. Use sampling functions to conduct simulations


### Glossary and Packages

Here are the main descriptive statistics functions we will be covering.

| Function| Description|
|:------|:--------|
| `table()` | Frequency table |
|     `mean(), median(), mode()`| Measures of central tendency|
|     `sd(), range(), var()`|    Measures of variability|
|     `max(), min()`|    Extreme values|
| `summary()`| Several summary statistics |

Here are the main statistical functions we will be covering.

| Function| Hypothesis Test| Additional Help |
|:------|:-------------------|:----|
|     `t.test()`|    One and two sample t-test| https://bookdown.org/ndphillips/YaRrr/htests.html#t-test-t.test
|     `cor.test()`|    Correlation test| https://bookdown.org/ndphillips/YaRrr/htests.html#correlation-cor.test
|     `chisq.test()`|    Chi-Square test| https://bookdown.org/ndphillips/YaRrr/htests.html#chi-square-chsq.test
|     `glm()`|    Regression| https://bookdown.org/ndphillips/YaRrr/regression.html|

Here are the random sampling functions we will use

| Function| Description| Additional Help |
|:------|:--------|:----|
|     `sample()`|    Draw a random sample of values from a vector| `?sample`
|     `rnorm()`|    Draw random values from a Normal distribution| `?rnorm()`
|     `runif`|    Draw random values from a Uniform distribution| `?runif()`


### Examples

- The following examples will take you through the steps of doing basic hypothesis tests. Follow along and try to see how piece of code works!

```{r, eval = FALSE, echo = TRUE, message = FALSE, warning = FALSE}
# -----------------------------------------------
# Examples of hypothesis tests on the diamonds
# ------------------------------------------------
library(tidyverse)

# First few rows of the diamonds data

diamonds

# -----
# Descriptive statistics
# -----

mean(diamonds$carat)   # What is the mean carat?
median(diamonds$price)   # What is the median price?
max(diamonds$depth)    # What is the maximum depth?
table(diamonds$color)    # How many observations for each color?

# -----
# 1-sample hypothesis test
# -----

# Q: Is the mean carat of diamonds different from .50?

htest_A <- t.test(x = diamonds$carat,     # The data
                  alternative = "two.sided",  # Two-sided test
                  mu = 0.5)                   # The null hyopthesis

htest_A            # Print result
names(htest_A)     # See all attributes in object
htest_A$statistic  # Get just the test statistic
htest_A$p.value    # Get the p-value
htest_A$conf.int   # Get a confidence interval

# -----
# 2-sample hypothesis test
# -----

# Q: Is there a difference in the carats of color = E and color = I diamonds?

htest_B <- t.test(formula = carat ~ color,     # DV ~ IV
                   alternative = "two.sided",  # Two-sided test
                   data = diamonds,         # The data
                   subset = color %in% c("E", "I")) # Compare Diet 1 and Diet 2

htest_B  # Print result

# -----
# Correlation test
# ------

# Q: Is there a correlation between carat and price?

htest_C <- cor.test(formula = ~ carat + price,
                    data = diamonds)

htest_C

# A: Yes. r = 0.92, t(53938) = 551.51, p < .001

# -----
# Regression
# ------

# Q: Create regression equation predicting price by carat, depth, table, and x

price_glm <- glm(formula = price ~ carat + depth + table + x,
                  data = diamonds)

# Print coefficients
price_glm

# Show as ANOVA table using the Anova function from the car package
car::Anova(price_glm)

# Q: Predict the price of the following 3 diamonds:

diamonds_new <- tibble(carat = c(.2, .6, .5),
                       depth = c(50, 46, 90),
                       table = c(40, 65, 70),
                       x = c(3.7, 4.2, 4.3))

predict(price_glm, 
        newdata = diamonds_new)

#       1         2         3 
# 4190.453  6088.398 -4471.817 

```


## Tasks

### Gettting started

A. For this practical, we'll use the `ACTG175` dataframe from the `speff2trial` package, load the package with the `library()` function. Also load the `tidyverse` as always!

```{r, message = FALSE, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}
library(tidyverse)
library(speff2trial)
```


B. Convert the data to a tibble (Hint, use assignment and `as_tibble()`)

```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}
ACTG175 <- as_tibble(ACTG175)
```


C. First thing's first, take a look at the data by printing it. It should look like this

```{r, eval = TRUE}
ACTG175
```

D. Before we can analyse the data, we need to make one important change. Specifically. we need to clarify that the `arms` column is a factor, *not* an integer. We'll also remove the patient id `pidnum` column as we don't need this

```{r}
# Data cleaning

ACTG175 <- ACTG175 %>%
  select(-pidnum) %>%     # Remove pidnum column
  mutate(
    arms = factor(arms, 
                  levels = c(0, 1, 2, 3),
                  labels = c("zid", "zid_did", "zid_zal", "did"))   # Convert arms to a factor
  )
```


### Descriptive statistics

D. What was the mean age of all patients?

E. What was the median weight of all patients?

F. What was the mean CD4 T cell count at baseline? What was it at 20 weeks?

G. How many patients have a history of intraveneous drug use and how many do not? (Hint: use `table()`)

### T tests with t.test()

1. Conduct a one-sample t-test comparing the age of the patients versus a null hypothesis of 40 years.

```{r}
t.test(x = ACTG175$age,
       alternative = "two.sided",
       mu = 40)
```

2. Now, compare the mean age to a null hypothesis of 35 years. What has changed?

```{r}
t.test(x = ACTG175$age,
       alternative = "two.sided",
       mu = 35)
```

3. A researcher wants to make sure that men and women in the clinical study are similar in terms of age. Conduct a two-sample t-test comparing the age of men versus women to test if they are indeed similar or not.

  - Women are coded as 0 in `gender`, and men are coded as 1. 
  - Be sure to use the formula notation `formula = age ~ gender`

```{r}
t.test(formula = age ~ gender,
       data = ACTG175,
       alternative = "two.sided")
```

4. Conduct a two-sample t-test comparing the number of days until the first occurrence of a major negative event (`days`) between those with a history of intravenous drug use (`drugs`) and those without a history of intravenous drug use

```{r}
t.test(formula = days ~ drugs,
       data = ACTG175)
```


### Correlation test with cor.test()

5. Do older people tend to weigh more? Conduct a correlation test between weight (`wtkg`) and age (`age`). What is your conclusion?

```{r}
cor.test(formula = ~ age + wtkg,
         data = ACTG175)
```

6. We would expect a correlation between CD4 T cell count at baseline (`cd40`) and at 20 weeks (`cd420`). But how strong is the correlation? Answer this question by conducting a correlation test between CD4 T cell count at baseline (`cd40`) and CD4 T cell count at 20 weeks (`cd420`).

```{r}
cor.test(formula = ~ cd40 + cd420,
         data = ACTG175)
```

7. Is there a relationship between CD4 T cell count at baseline (`cd40`) and the number of days until the first occurrence of major negative event (`days`)?

```{r}
cor.test(formula = ~ cd40 + days,
         data = ACTG175)
```

8. Only considering men, is there a correlation between CD4 T cell count at baseline (`cd40`)and CD8 T cell count at baseline (`cd80`)?

  - Include the argument `subset = gender == 0` to restrict the analysis to men
    
```{r}
cor.test(formula = ~ cd40 + cd80,
         data = ACTG175,
         subset = gender == 0)
```

9. Now, repeat the previous test, but only for women

```{r}
cor.test(formula = ~ cd40 + cd80,
         data = ACTG175,
         subset = gender == 1)
```

### Chi-square test with chisq.test()

10. Do men and women (`gender`) have different distributions of race (`race`)? That is, is the percentage of women who are white differ from the percentage of men who are white?

  - Be sure to create a table of gender and race values with `table(ACTG175$gender, ACTG175$race)`

```{r}
chisq.test(table(ACTG175$gender, ACTG175$race))
```

11. Is there a relationship between a history of intravenous drug use (`drugs`) and hemophilia (`hemo`)?

```{r}
chisq.test(table(ACTG175$hemo, ACTG175$drugs))
```

12. Is there a relationship between homosexual activity (`homo`) and gender (`gender`)

```{r}
chisq.test(table(ACTG175$homo, ACTG175$gender))
```

### Linear Model with glm()

15. Which demographic variables predict days until the first occurence of a major negative event (`days`)? To answer this, conduct a linear regression analysis predicting `days` as a function of age (`age`), weight (`wtkg`), race (`race`) and gender (`gender`). Call the object `days_A_glm`.

```{r}
days_A_glm <- glm(formula = days ~ age + wtkg + race + gender,
                     data = ACTG175)

summary(arms_cd820_aov)

TukeyHSD(arms_cd820_aov)
```

16. Print the `days_A_glm` object to see the coefficients.

```{r}
days_A_glm
```

17. Using the `summary()` function, explore the `days_A_glm` object to see which coefficients are significant.

18. Using the `names()` function, look at what the named elements in the `days_A_glm` object are.

19. Using the `days_A_glm$__` notation, print a vector of the model coefficients (`$coefficients`).

20. Look at the `$data`, `$fitted.values` and `$residuals` elements of the `days_A_glm` object. What do you think these are?

21. Now create a new regression object `days_B_glm` where you predict `days` as a function of the treatment arm (`arms`). Explore the object. Do you find that there was an effect of the treatment arm on `days`?

```{r}
days_B_glm <- glm(formula = days ~ arms,
                  data = ACTG175)
```

22. Does the effect of treatment arm on days hold if you only consider men (`gender == 1`) above the age of 30 (`age > 30`)? To answer this, repeat your previous regression, but include the appropriate arguments to `subset`



## Extras and Challenges

### Generating random samples from distributions

19. You can easily generate random samples from statistical distributions in R. To see all of them, run `?distributions`. For example, to generate samples from the well known Normal distribution, you can use `rnorm()`. Look at the help menu for `rnorm()` to see its arguments. 

20. Using `rnorm()`,create a new object `samp_10` which is 10 samples from a Normal distribution with mean 10 and standard deviation 5. Print the object to see what the elements look like. What should the mean and standard deviation of this sample? be? Test it by evaluating its mean and standard deviation directly using the appropriate functions. Then, do a one-sample t-test on this sample against the null hypothesis that the true mean is 12. What are the results? 

21. Evalaute your code for the previous question *exactly* as it is -- that is, don't change *anything*. What are the new values in `samp_10` and the new mean, standard deviation, and t-test result. Why are the new results different?

22. Now, create a new object called `samp_1000` which is 1,000 samples from a Normal distribution (again with mean 12 and standard deviation 5). Print this object to see what it looks like. What should the mean and standard deviation of this sample be? Do the same hypothesis test as you did in the previous question. What is your new p-value?


### You choose the test!

13. Only for patients older than 40, is there a relationship between antiretroviral history (`str2`) and race (`race`)?

   - Create a new dataframe called `ACTG175.o40 <- subset(ACTG175, age > 40)` and then do your analysis on this new dataframe.
   
   
```{r}
ACTG175.o40 <- subset(ACTG175, age > 40)

chisq.test(table(ACTG175.o40$str2, ACTG175.o40$race))
```

14. Now repeat the previous analysis, but only for male patients

  - Create a new dataframe called `ACTG175.male <- subset(ACTG175, gender == 0)` and then do your analysis on this new dataframe.

```{r}
ACTG175.male <- subset(ACTG175, gender == 0)

chisq.test(table(ACTG175.male$str2, ACTG175.male$race))
```


25. Is there a difference in the CD4 T cell count at baseline between whites and non-whites? Answer this by conducting the appropriate hypothesis test.

```{r}
t.test(formula = cd40 ~ race,
       data = ACTG175,
       alternative = "two.sided")
```

26. A researcher is particularly interested in whether or not there is a difference in the number of days until the first occurrence of a major negative event between patients taking zidovudine and those taking didanosine. Conduct the appropriate test to answer this question.
    
```{r}
t.test(formula = days ~ arms,
       data = ACTG175,
       subset = arms %in% c(0, 3))
```

27. A researcher wants to know if the relationship between CD4 T cell count at baseline and age is similar for whites and non-whites. Specifically, she wants to know if both correlations are significant (and in the same direction!) or not. Conduct the appropriate statistical test separately for both groups. Are the conclusions the same or different?

```{r}
cor.test(formula = ~ cd40 + days,
         data = subset(ACTG175, race == 0))

cor.test(formula = ~ cd40 + days,
         data = subset(ACTG175, race == 1))
```

28. A researcher is concerned that patients were not properly randomly assigned to the different treatment arms. Using the appropriate test(s), see if there is a significant imbalance between treatment arms in terms of gender, drug use, race, and homosexual activity. Do you find evidence for a significant imbalance in any of these domains?

```{r}
chisq.test(table(ACTG175$gender, ACTG175$arms))
chisq.test(table(ACTG175$race, ACTG175$arms))
chisq.test(table(ACTG175$drugs, ACTG175$arms))
```


# Additional reading

- For more details on hypothesis tests in R, check out the chapter on hypothesis tests in YaRrr! The Pirate's Guide to R [YaRrr! Chapter Link](https://bookdown.org/ndphillips/YaRrr/htests.html)

- For more advanced mixed level ANOVAs with random effects, consult the `afex` and `lmer` packages.

- To do Bayesian versions of common hypothesis tests, try using the `BayesFactor` package. [BayesFactor Guide Link](https://cran.r-project.org/web/packages/BayesFactor/vignettes/manual.html)
